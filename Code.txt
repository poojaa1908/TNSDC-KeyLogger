import os
import difflib
from docx import Document
from docx.shared import RGBColor, Pt
from docx.oxml.ns import qn
from docx.oxml import OxmlElement

def read_file_lines(file_path):
    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
        return f.readlines()

def add_colored_paragraph(doc, line, color_rgb, bold=False):
    para = doc.add_paragraph()
    run = para.add_run(line.rstrip('\n'))
    run.font.color.rgb = color_rgb
    run.font.bold = bold
    run.font.name = 'Courier New'
    run.font.size = Pt(9)

def add_table_summary(doc, added, deleted, modified):
    doc.add_paragraph('Summary of Comparison').bold = True
    table = doc.add_table(rows=4, cols=2)
    table.style = 'Table Grid'
    table.cell(0, 0).text = 'Metric'
    table.cell(0, 1).text = 'Count'
    table.cell(1, 0).text = 'Added Files'
    table.cell(1, 1).text = str(added)
    table.cell(2, 0).text = 'Deleted Files'
    table.cell(2, 1).text = str(deleted)
    table.cell(3, 0).text = 'Modified Files'
    table.cell(3, 1).text = str(modified)
    doc.add_paragraph()  # Spacer

def compare_file_content(file1, file2, doc, index):
    lines1 = read_file_lines(file1)
    lines2 = read_file_lines(file2)
    diff = difflib.ndiff(lines1, lines2)

    doc.add_paragraph(f'Modified File {index}: {os.path.basename(file1)}').bold = True
    for line in diff:
        if line.startswith('+ '):
            add_colored_paragraph(doc, line, RGBColor(0, 128, 0), bold=True)  # Green
        elif line.startswith('- '):
            add_colored_paragraph(doc, line, RGBColor(255, 0, 0), bold=True)  # Red
        elif line.startswith('? '):
            continue  # Skip hints from ndiff
        else:
            add_colored_paragraph(doc, line, RGBColor(0, 0, 0))  # Normal line
    doc.add_paragraph()  # Add space

def compare_folders(folder1, folder2, output_docx_path):
    doc = Document()
    folder1_files = set()
    folder2_files = set()

    added_files = []
    deleted_files = []
    modified_files = []

    for dirpath, _, filenames in os.walk(folder1):
        for f in filenames:
            rel_path = os.path.relpath(os.path.join(dirpath, f), folder1)
            folder1_files.add(rel_path)

    for dirpath, _, filenames in os.walk(folder2):
        for f in filenames:
            rel_path = os.path.relpath(os.path.join(dirpath, f), folder2)
            folder2_files.add(rel_path)

    all_files = folder1_files.union(folder2_files)

    mod_index = 1
    for file in sorted(all_files):
        path1 = os.path.join(folder1, file)
        path2 = os.path.join(folder2, file)

        if file not in folder1_files:
            added_files.append(file)
            doc.add_paragraph(f'Added File: {file}').bold = True
            lines = read_file_lines(path2)
            for line in lines:
                add_colored_paragraph(doc, line, RGBColor(0, 128, 0))  # Green
            doc.add_paragraph()
        elif file not in folder2_files:
            deleted_files.append(file)
            doc.add_paragraph(f'Deleted File: {file}').bold = True
            lines = read_file_lines(path1)
            for line in lines:
                add_colored_paragraph(doc, line, RGBColor(255, 0, 0))  # Red
            doc.add_paragraph()
        else:
            # Compare content
            if read_file_lines(path1) != read_file_lines(path2):
                modified_files.append(file)
                compare_file_content(path1, path2, doc, mod_index)
                mod_index += 1

    # Add summary at top
    docx_file = Document()
    add_table_summary(docx_file, len(added_files), len(deleted_files), len(modified_files))
    for element in doc.element.body:
        docx_file.element.body.append(element)

    docx_file.save(output_docx_path)
    print(f'Document saved as: {output_docx_path}')
