import os
import difflib
from pathlib import Path

def read_file_lines(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
            return f.readlines()
    except Exception as e:
        return [f"<<Error reading file: {e}>>\n"]

def compare_solutions(folder1, folder2, output_report_path):
    report = []

    path1 = Path(folder1)
    path2 = Path(folder2)

    files1 = {str(p.relative_to(path1)) for p in path1.rglob('*') if p.is_file()}
    files2 = {str(p.relative_to(path2)) for p in path2.rglob('*') if p.is_file()}

    added = sorted(files2 - files1)
    deleted = sorted(files1 - files2)
    common = sorted(files1 & files2)

    report.append("===== Added Files (in solution 2 but not in solution 1) =====")
    report.extend(added or ["None"])

    report.append("\n===== Deleted Files (in solution 1 but not in solution 2) =====")
    report.extend(deleted or ["None"])

    report.append("\n===== Modified Files =====")
    for rel_path in common:
        f1 = path1 / rel_path
        f2 = path2 / rel_path

        lines1 = read_file_lines(f1)
        lines2 = read_file_lines(f2)

        if lines1 != lines2:
            report.append(f"\n--- {rel_path} ---")
            diff = difflib.unified_diff(
                lines1, lines2,
                fromfile=str(f1),
                tofile=str(f2),
                lineterm=''
            )
            report.extend(diff)

    # Write to output file
    with open(output_report_path, 'w', encoding='utf-8') as out_file:
        out_file.write('\n'.join(report))

    print(f"âœ… Report saved to: {output_report_path}")

# ======== USAGE ========
# Update with the paths of your extracted solutions
solution1_path = r"C:\path\to\Solution1"
solution2_path = r"C:\path\to\Solution2"
report_output_path = "powerapps_solution_diff.txt"

compare_solutions(solution1_path, solution2_path, report_output_path)
